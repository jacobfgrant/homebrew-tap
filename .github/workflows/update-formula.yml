name: Update Formula

on:
  workflow_dispatch:
    inputs:
      formula:
        description: "Formula name (e.g., unity-rearm)"
        required: true
      repo:
        description: "Source repo (e.g., jacobfgrant/unity-rearm)"
        required: true
      version:
        description: "Release tag (e.g., v0.1.0)"
        required: true

permissions:
  contents: write

jobs:
  update-formula:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download tarball and compute SHA256
        id: sha
        run: |
          url="https://github.com/${{ inputs.repo }}/archive/refs/tags/${{ inputs.version }}.tar.gz"
          echo "Downloading ${url}..."
          curl -fsSL -o release.tar.gz "${url}"

          # Validate download isn't empty
          size=$(stat --format=%s release.tar.gz)
          if [ "$size" -lt 100 ]; then
            echo "::error::Downloaded file is suspiciously small (${size} bytes)"
            exit 1
          fi

          sha256=$(sha256sum release.tar.gz | awk '{print $1}')
          echo "sha256=${sha256}" >> "$GITHUB_OUTPUT"
          echo "SHA256: ${sha256}"

      - name: Update formula
        run: |
          formula_file="Formula/${{ inputs.formula }}.rb"
          if [ ! -f "${formula_file}" ]; then
            echo "::error::Formula file not found: ${formula_file}"
            exit 1
          fi

          # Update URL
          sed -i "s|url \"https://github.com/${{ inputs.repo }}/archive/refs/tags/.*\.tar\.gz\"|url \"https://github.com/${{ inputs.repo }}/archive/refs/tags/${{ inputs.version }}.tar.gz\"|" "${formula_file}"

          # Update SHA256
          sed -i "s|sha256 \"[a-f0-9]\{64\}\"|sha256 \"${{ steps.sha.outputs.sha256 }}\"|" "${formula_file}"

          echo "Updated ${formula_file}:"
          cat "${formula_file}"

      - name: Commit and push
        run: |
          git diff --quiet && { echo "No changes to commit."; exit 0; }

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/
          git commit -m "Update ${{ inputs.formula }} to ${{ inputs.version }}"
          git push
